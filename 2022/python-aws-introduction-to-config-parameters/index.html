<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="chrome=1"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><link rel=prev href=https://vittoriomattei.com/2022/python-if-else-alternatives/><link rel=canonical href=https://vittoriomattei.com/2022/python-aws-introduction-to-config-parameters/><link rel='shortcut icon' type=image/x-icon href=../../favicon.ico><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#da532c"><meta name=theme-color content="#ffffff"><title>Python configuration parameters with AWS | Vittorio Mattei
</title><meta name=title content="Python configuration parameters with AWS | Vittorio Mattei"><link rel=stylesheet href=https://vittoriomattei.com/font/iconfont.css><link rel=stylesheet href=https://vittoriomattei.com/css/main.min.css><meta name=twitter:card content="summary"><meta name=twitter:title content="Python configuration parameters with AWS"><meta name=twitter:description content="Load configuration parameters in Python with boto3, AWS and SSM Parameter Store"><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"Python configuration parameters with AWS","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/vittoriomattei.com\/2022\/python-aws-introduction-to-config-parameters\/"},"genre":"posts","keywords":"programming, python, beginner, AWS","wordcount":1761,"url":"https:\/\/vittoriomattei.com\/2022\/python-aws-introduction-to-config-parameters\/","datePublished":"2022-09-10T00:00:00\u002b00:00","dateModified":"2022-09-10T00:00:00\u002b00:00","publisher":{"@type":"Organization","name":"Vittorio Mattei","logo":{"@type":"ImageObject","url":"https:\/\/vittoriomattei.com\/","width":null,"height":null}},"author":{"@type":"Person","name":"Vittorio Mattei"},"description":"Load configuration parameters in Python with boto3, AWS and SSM Parameter Store"}</script></head><body><div class=wrapper><nav class=navbar><div class=container><div class="navbar-header header-logo"><a href=https://vittoriomattei.com/>Vittorio Mattei</a></div><div class="menu navbar-right"><a class=menu-item href=../../resume/resume.pdf title>Rèsumè</a>
<a class=menu-item href=../../posts/ title>Blog</a>
<a class=menu-item href=../../categories/ title>Categories</a>
<a class=menu-item href=../../about title>About</a>
<a href=javascript:void(0); class=theme-switch><i class="iconfont icon-sun"></i></a>&nbsp;</div></div></nav><nav class=navbar-mobile id=nav-mobile style=display:none><div class=container><div class=navbar-header><div><a href=javascript:void(0); class=theme-switch><i class="iconfont icon-sun"></i></a>&nbsp;<a href=https://vittoriomattei.com/>Vittorio Mattei</a></div><div class=menu-toggle><span></span><span></span><span></span></div></div><div class=menu id=mobile-menu><a class=menu-item href=../../resume/resume.pdf title>Rèsumè</a>
<a class=menu-item href=../../posts/ title>Blog</a>
<a class=menu-item href=../../categories/ title>Categories</a>
<a class=menu-item href=../../about title>About</a></div></div></nav><main class=main><div class=container><article class=post-warp><header class=post-header><h1 class=post-title>Python configuration parameters with AWS</h1><div class=post-meta>Written by <a href=https://vittoriomattei.com/ rel=author>Vittorio Mattei</a> with ♥
<span class=post-time>on <time datetime=2022-09-10>10 September 2022</time>
</span>in
<i class="iconfont icon-folder"></i>
<span class=post-category><a href=https://vittoriomattei.com/categories/programming/>Programming </a></span><i class="iconfont icon-timer"></i>
9 min</div></header><div class=post-content><p>Loading configuration parameters in your program is an operation that every developer will probably implement at some point while writing code.</p><p>While the code can be as simple as <code>CONSTANT = value</code>, this is probably not the best idea of how to implement a configuration for your software.</p><p>In this article I want to analyze some concepts that you can use for your implementation. The implementation used here will show how to apply those concepts when using <strong>Python</strong>, <strong>AWS</strong> and <strong>boto3</strong> as your tech stack.</p><h1 id=1-hard-coded-value>1. Hard coded value</h1><p>This is the easiest way to implement a configuration parameter when you&rsquo;re starting your project. You don&rsquo;t know if this parameter will change or if it depends on other features. You just want to use a <strong>constant</strong> value in multiple places of your code.</p><p>The implementation is as simple as this:</p><pre tabindex=0><code># constants.py

DB_USERNAME = &#34;admin&#34;
</code></pre><p>You then simply import <em>constants.py</em> and use the variable in your code.</p><p>There are multiple drawbacks to this method:</p><ul><li>Changing a value requires editing the source code and re-launching the program.</li><li>If your repository is public, everyone will see the value. This is problematic when dealing with secrets (like passwords).</li><li>If multiple programs use the same value, you need to edit each program&rsquo;s source code when changing your parameter.</li></ul><h1 id=2-configuration-file>2. Configuration file</h1><p>This is especially effective when dealing with compiled languages, where changing a value will require a re-compilation of your code.</p><p>When loading parameters from a file, you only need tu re-run the program and the new value will be loaded in memory.</p><p>Let&rsquo;s improve the example written before:</p><pre tabindex=0><code># constants.json

{
    &#34;DB_USERNAME&#34;: &#34;admin&#34;
}
</code></pre><p>We can use any file format we want. <a href=https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/JSON>JSON</a>, <a href=https://yaml.org/spec/1.2.2/>YAML</a> and <a href=https://toml.io/en/>TOML</a> are some common formats you can use to define your configuration file.</p><p>We then load the file into memory:</p><pre tabindex=0><code># constants.py
import json

file_name = &#34;constants.json&#34;
with open(file_name, &#34;r&#34;) as f:
    json_config = json.load(f)

DB_USERNAME = json_config.get(&#34;DB_USERNAME&#34;) 
</code></pre><p>We don&rsquo;t need to edit the code when we want to change the value of our parameter, we just edit the configuration file.</p><p>Advantages:</p><ul><li>Value can change without editing code.</li><li>Multiple file formats supported and we can use default values when a parameter is not defined in the configuration file.</li><li>You can push in your repository an example file and other developer can define their own values without exposing secrets.</li></ul><p>Disadvantages:</p><ul><li>You still need to define all your common parameters for each project.</li><li>Reloading parameters still requires restarting the program.</li><li>Changing parameters requires editing the file on the host machine.</li><li>Working with Docker and serverless can be difficult, as it might not be that easy to edit the file locally, and you might need to push it in your repository.</li></ul><h2 id=improvement-lets-move-the-file-on-the-cloud>Improvement: let&rsquo;s move the file on the cloud</h2><p>There is no reason that we need to maintain the file locally. In the era of cloud storage, it&rsquo;s just so easy to load the file on any cloud storage provider and then download it. To do this we need a library to interact with the cloud provider: in this article we will use <strong>AWS</strong> as cloud provider and <a href=https://boto3.amazonaws.com/v1/documentation/api/latest/index.html>boto3</a> as the library.</p><p>Boto3 allows Python software to interact with <strong>AWS</strong> resources, mainly to dynamically operate on them.</p><p>**<em>Note: for cloud infrastructure creation, it is better to use solutions like CDK or Terraform, as they allow to easily rollback and delete the defined infrastructure**</em></p><p>We simply load the configuration on <strong>AWS S3</strong>. The path will be <em>configurations/db_config.json</em>. Remember that S3 resources follow the pattern <em>BUCKET_NAME/KEY</em>.</p><p>We now need to add code to read the configuration from S3.</p><pre tabindex=0><code># constants.py

import boto3
import json


bucket = &#34;configurations&#34;
key = &#34;db_config.json&#34;

s3_read_response = boto3.client(&#34;s3&#34;).get_object(Bucket=bucket, Key=key)
json_config = json.loads(s3_read_response[&#39;Body&#39;].read())

DB_USERNAME = json_config.get(&#34;DB_USERNAME&#34;) 
</code></pre><p>Remember that in a real case you also want to handle exception for when you don&rsquo;t have access to a file or you can&rsquo;t find a file. You might also get a corrupt file or the file is not a <strong>JSON</strong>, so keep in mind these aspects when implementing this code.</p><p>You can find more information about boto3 and s3 <a href=https://boto3.amazonaws.com/v1/documentation/api/latest/reference/services/s3.html#s3>here</a>.</p><p>Advantages:</p><ul><li>The configuration can now be edited only once and loaded on <strong>s3</strong>, possibly with <strong>CI/CD</strong> pipelines.</li><li>You can create the file on a different project, edit it locally and push it on the cloud instead of operating on the host machine.</li></ul><p>Disadvantages:</p><ul><li>Secrets are still exposed.</li><li>Reloading values still requires a restart.</li></ul><h1 id=environment-variables>Environment variables</h1><p>There is a simple solution for when you don&rsquo;t want to expose a secret in a configuration file or hard code it in your program. We can use <strong>environment variables</strong> for this.</p><p>Environment variables can easily be defined and kept secret to the outside world (unless someone gains access to the machine and you might have even bigger problems). You can define them on your <strong>local machine</strong> when testing your software, in <strong>Dockerfile</strong> and <strong>docker-compose</strong> for easy deployment, in your <strong>CI/CD</strong> pipeline or in cloud providers container solutions (see <a href=https://docs.aws.amazon.com/AmazonECS/latest/developerguide/taskdef-envfiles.html>here</a> for an example with <strong>AWS ECS</strong>).</p><p>Regarding the previous example, there are two methods that we could use to hide <em>DB_USERNAME</em> from a public repository. We assume that we created a different repository that holds a Python script that creates <em>&ldquo;db_config.json&rdquo;</em> with the desired values and automatically pushes it to S3 using boto3 when making changes to it. The config file itself is only found on S3, where project contributors won&rsquo;t have direct access.</p><ol><li>We can inject the environment variable into the main program and retrieve it without using <em>db_config.json</em></li><li>We can inject it into the <em>config creator</em> program, that will then push the configuration file with the variable to S3.</li></ol><p>The code to retrieve the variable is the same, so it is only a matter of use-case and preference for which one you choose. Nothing stops us from mixing them for different constants. We could save common variables in a <em>.json</em> and use environment variables for program specific values.</p><p>Let&rsquo;s see the second case:</p><pre tabindex=0><code># constants.py

import os
DB_USERNAME = os.environ.get(&#34;DB_USERNAME&#34;, &#34;default&#34;)
</code></pre><p>This is pretty similar to getting values from a json: we can specify the <strong>key</strong> and a <strong>default</strong> value for when the key is not found.</p><p>Now, we don&rsquo;t need to write constants in any repository and we can allow external contributors to check out the source code of the program we&rsquo;re developing.</p><p>We can also leverage environment variables when developing deployment infrastructure with tools like <strong>Terraform</strong>. For example, we can deploy a database on a machine with a dynamic public IP and automatically retrieve that IP and pass it as an environment variable to the main program when deploying it on the cloud.</p><p>There are still a couple of issues with this approach:</p><ul><li>We can&rsquo;t change the parameters without a restart (or&mldr; a <em>crash</em>!).</li><li>Somewhere, these parameters and secrets are still written. It&rsquo;s easy to save them as environment variables on our machine or create another file that is not committed to git, but what if there are multiple developers contributing to the same project and deployment? Passing those value around on Slack is not optimal nor advised.</li></ul><h1 id=store-parameters-on-the-cloud-ssm-parameter-store>Store parameters on the cloud: SSM Parameter Store</h1><p>Let&rsquo;s solve the second issue: where can we safely store these parameters so that they are available to any team member?</p><p>We can use cloud services that offer storing parameters as the main function. <strong>AWS</strong> offers <strong>SSM Parameter Store</strong>. It is possible to save parameters (secrets or not) there that can easily be retrieved by applications and users that have permission.</p><p>You can refer to <a href=https://docs.aws.amazon.com/systems-manager/latest/userguide/systems-manager-parameter-store.html>AWS documentation</a> for how to save parameters there. Let&rsquo;s see how we can then use them in our Python application.</p><pre tabindex=0><code># constants.py

try:
    client = boto3.client(&#34;ssm&#34;)
    DB_USERNAME = client.get_parameter(Name=&#34;common/db/username&#34;)[&#34;Parameter&#34;][&#34;Value&#34;]
    DB_PASSWORD = client.get_parameter(Name=&#34;common/db/password&#34;, WithDecryption=True)[&#34;Parameter&#34;][&#34;Value&#34;]
except Exception:
    # handle errors
</code></pre><p>In this case, you cannot give a default value to the parameters, so you should handle exceptions accordingly. Possible causes could be due to missing permissions, invalid parameter names, error in AWS connection.</p><p>You could either define a <strong>default</strong> value in the except block, <strong>retry</strong> or <strong>raise</strong> exceptions depending on your use case.</p><p>As you can see, you can specify a <em>WithDecryption</em> parameter that allows you to decode secret values stored on AWS, like passwords and keys.</p><p>There is only one issue left after this iteration: we still need to restart the program if we need to update the value.</p><h1 id=caching-ssm-cache>Caching: SSM Cache</h1><p>We can solve this last issue by using a <a href=https://en.wikipedia.org/wiki/Cache_(computing)>cache</a>.</p><p>With a <strong>cache</strong>, we can save a value in memory for easy retrieval. Usually caches have a size, where frequent and recent elements are saved to cut access time to peripherals or external services.</p><p>In this case, we use a <strong>cache</strong> to save a value in memory for a certain amount of time.</p><p>This allows us to fetch the parameter value from AWS, keep it in memory for a set time and then refresh it automatically.</p><p>While it can be an interesting exercise to implement your own caching module for parameters, you can use the module <a href=https://pypi.org/project/ssm-cache/>ssm-cache</a> for a fast implementation.</p><p>The above code would become this:</p><pre tabindex=0><code># constants.py

from ssm_cache import SSMParameterGroup
DB = SSMParameterGroup(max_age=300)  # Time in seconds
DB_USERNAME = DB.parameter(&#34;common/db/username&#34;)
DB_PASSWORD = DB.parameter(&#34;common/db/password&#34;)

value_1 = DB_USERNAME.value
value_2 = DB_USERNAME.value
</code></pre><p>After the set time, your parameter will be refreshed automatically, so you don&rsquo;t need to restart the program.</p><h1 id=additional-ideas>Additional ideas</h1><p>There are still some issues left after all this.</p><p>For instance, what if you changed a parameter and your program uses the cached value before this is updated? You would get an exception.</p><p>We can still mitigate this issue by carefully handling exception. When an error arises due to an expired parameter, we can re-fetch the parameter and retry the operation or alert the calling function/user/service to retry.</p><p>We could also always fetch the parameter from <strong>SSM</strong> instead of caching it, but be careful as this won&rsquo;t scale well!</p><p>An excelent way to keep your parameters updated would be to automatically <em>alert</em> all the services that use one parameter that its value changed and they need to re-fetch it.<br>You could do this with the <em>event watcher</em> of your cloud provider (if it allows checking for updated parameters), or you could create an additional service that allows you to update a parameter and alert all services (be careful, as an attacker gaining access to this service would mean losing all your secrets!).</p><p>Note that each service should implement an endpoint to receive this update <em>event</em>. If a service is down at that moment, it wouldn&rsquo;t be an issue, as they would fetch the new parameter anyway at the next restart.</p></div><div class=post-copyright><p class=copyright-item><span>Words:</span>
<span>1761</span></p><p class=copyright-item><span>Share:</span>
<span><a href="//twitter.com/share?url=https%3a%2f%2fvittoriomattei.com%2f2022%2fpython-aws-introduction-to-config-parameters%2f&amp;text=Python%20configuration%20parameters%20with%20AWS&amp;via=" target=_blank title="Share on Twitter"><i class="iconfont icon-twitter"></i>
</a><a href="//www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fvittoriomattei.com%2f2022%2fpython-aws-introduction-to-config-parameters%2f" target=_blank title="Share on Facebook"><i class="iconfont icon-facebook"></i>
</a><a href="//reddit.com/submit?url=https%3a%2f%2fvittoriomattei.com%2f2022%2fpython-aws-introduction-to-config-parameters%2f&amp;title=Python%20configuration%20parameters%20with%20AWS" target=_blank title="Share on Reddit"><i class="iconfont icon-reddit"></i>
</a><a href="//www.linkedin.com/shareArticle?url=https%3a%2f%2fvittoriomattei.com%2f2022%2fpython-aws-introduction-to-config-parameters%2f&amp;title=Python%20configuration%20parameters%20with%20AWS" target=_blank title="Share on LinkedIn"><i class="iconfont icon-linkedin"></i></a></span></p><p class=copyright-item>Released under <a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></p></div><div class=post-tags><section><i class="iconfont icon-icon-tag"></i>Tag:
<span class=tag><a href=https://vittoriomattei.com/tags/programming/>#programming</a></span>
<span class=tag><a href=https://vittoriomattei.com/tags/python/>#python</a></span>
<span class=tag><a href=https://vittoriomattei.com/tags/beginner/>#beginner</a></span>
<span class=tag><a href=https://vittoriomattei.com/tags/aws/>#AWS</a></span></section><section><a href=javascript:window.history.back();>Back</a></span> ·
<span><a href=https://vittoriomattei.com/>Home</a></span></section></div><div class=post-nav><a href=https://vittoriomattei.com/2022/python-if-else-alternatives/ class=prev rel=prev title="Python if-else alternatives for better design"><i class="iconfont icon-dajiantou"></i>&nbsp;Python if-else alternatives for better design</a></div><div class=post-comment><script src=https://giscus.app/client.js data-repo=vittoriom94/vittoriom94.github.io data-repo-id="MDEwOlJlcG9zaXRvcnkxNTkyMzM5ODc=" data-category=Announcements data-category-id=DIC_kwDOCX23w84CQZBQ data-mapping=pathname data-strict=0 data-reactions-enabled=1 data-emit-metadata=0 data-input-position=top data-theme=light data-lang=en data-loading=lazy crossorigin=anonymous async></script><noscript>Please enable JavaScript to view the <a href=https://giscus.app/>comments powered by Giscus.</a></noscript></div></article></div></main><footer class=footer><div class=copyright>&copy;
<span>Crafted with ❤️ by <a href=https://github.com/Fastbyte01/KeepIt target=_blank rel="external nofollow noopener noreffer">KeepIt</a> & <a href=https://gohugo.io/ target=_blank rel="external nofollow noopener noreffer">Hugo</a></span></div></footer><script src=../../js/vendor_no_gallery.min.js async></script></div></body></html>